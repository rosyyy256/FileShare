@using FileShare.Services;
@using MongoDB.Bson;
@using MongoDB.Driver;
@inject ApplicationContext db
@inject NavigationManager NavigationManager
@inject DisposableDictionary<string> DisposableLinkService
@inject ISnackbar Snackbar

<MudTable Items="@files"
          Hover=true>
    <RowTemplate>
        <MudTd>@context.name</MudTd>
        <MudTd><MudButton Href="@($"/file/{context.id}")">Download</MudButton></MudTd>
        <MudTd><MudButton OnClick="() => DeleteFile(context.id)">Delete</MudButton></MudTd>
        <MudTd><MudButton OnClick="() => ShareFile(context.id)">Share</MudButton></MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<(string name, string id)> files = new();

    protected override async Task OnInitializedAsync()
    {
        var dbFiles = (await db.Bucket.FindAsync("{}")).ToList();
        files = dbFiles.Select(f => (f.Filename, f.Id.ToString())).ToList();
    }

    private async Task DeleteFile(string id)
    {
        await db.Bucket.DeleteAsync(new ObjectId(id));
        files.RemoveAt(files.FindIndex(f => f.id == id)); // TODO: refactor this
    }

    private void ShareFile(string id)
    {
        var temporaryId = DisposableLinkService.Create(id);
        var link = $"{NavigationManager.BaseUri}disposable/{temporaryId}";
        Snackbar.Add(link);
    }
}
